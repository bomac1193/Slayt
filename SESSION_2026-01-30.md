# Session Log (2026-01-30)

This file captures the key outcomes, decisions, and code changes from a long debug/build session across **Slayt** and **Folio** so it can be reused as context in a new chat.

## Summary (what shipped)

- **Folio ↔ Slayt connection restored:** fixed local CORS on Folio auth/session/callback flows so “Connect to Folio” works from the Slayt client.
- **Grid preview editing made real:** selecting different grid items binds the right panel to the correct item; edits are per-post, auto-saved on selection change, and persist on refresh.
- **AI generation stabilised:** removed ` ```json` artefacts, added safer JSON parsing, and switched caption/hashtag generation to be image-aware when possible (multimodal).
- **ERRC → code surface started:** added shared taste context materialisation, minimal 1193 schema endpoints, a 3-signal dashboard endpoint, and a taste-aware rollout auto-playbook endpoint.

## Next (implementation queue)

1) **On-brand classifier + lexicon guardrails (Week 2):** explicit brand glossary, scoring function, and UI feedback (“on-brand %” + why).
2) **A/B harness (Week 3):** store variants per post, deploy flags, capture outcomes; wire into Taste signals automatically.
3) **3-signal dashboard (Week 4):** replace placeholder ROAS with real performance ingestion + attribution; add “90→14 day cycle” timestamps.
4) **Cross-channel signal capture (Week 1+):** unify IG/TikTok/YT “like/save/skip/dislike” into the genome via `folio-signal` + platform adapters.
5) **Partner Taste API (moat):** define public schema boundaries, auth, rate limits, and provenance.

## Repos touched

- `Slayt/` (GitHub: `bomac1193/Postpanda`)
- `folio/` (GitHub: `bomac1193/folio`)

## Dev topology (local)

- Slayt API: `http://localhost:3002`
- Slayt client (Vite): `http://localhost:5173`
- Folio (Next.js): `http://localhost:3007`

Key env wiring used:
- Slayt server `.env`: `FOLIO_API_URL=http://localhost:3007`, `FRONTEND_URL=http://localhost:5173`
- Slayt client `client/.env.local`: `VITE_API_URL=http://localhost:3002`, `VITE_FOLIO_API_URL=http://localhost:3007`

## Major issues resolved

### 1) Folio connect/login from Slayt: CORS failures

Symptoms:
- `Access-Control-Allow-Origin` missing on `http://localhost:3007/api/auth/callback/credentials` redirects.
- Slayt client login spinner / “failed to fetch”.

Fix:
- Added Folio middleware CORS headers for all routes (including redirects) and restarted Folio on port `3007`.
- Verified via preflight and session fetch that Folio responds with correct CORS headers for origin `http://localhost:5173`.

### 2) Grid Planner preview: right panel showing the same post for multiple images

Symptoms:
- Clicking different images in preview mode showed the same post in the right-hand panel.

Fix:
- Selection in preview mode now resolves against both the grid posts and preview reels list, so the right panel binds to the correct clicked item.

### 3) Post details editing: edits not persisting per post / lost on refresh

Goal:
- Each grid item has its own caption/hashtags; switching items keeps edits separate and saved.

Fix:
- `PostDetails` now:
  - Auto-saves the previous post when switching selection.
  - Persists caption/hashtags to the backend via `contentApi.update` (not only local store).
  - Restores per-post values on selection and after page refresh.

### 4) AI generation returning ` ```json` / code-fence artefacts (and generic outputs)

Symptoms:
- Second (and later) generations sometimes returned ` ```json` or showed `json` literally in the UI.
- Some generations were generic because they had no image context.

Fixes:
- Hardened JSON parsing in `alchemyAiService` (extracts fenced JSON, then parses; won’t treat ` ```json` as output).
- Added response-format enforcement (`json_object`) with safe retry fallback for OpenAI chat completions.
- Added multimodal generation in `aiService` for captions and hashtags when `mediaUrl` is available so outputs are based on the actual image.
- Added extra cleaning on both server and client to strip code fences if they slip through.

## ERRC implementation work (in code)

This was implemented as “minimum shippable” API surface and guardrail wiring:
- Shared taste context materialisation (`tasteContextService`)
- 1193-ish schema endpoints:
  - `GET /api/genome/schema`
  - `GET /api/genome/context`
  - `GET /api/genome/dashboard` (3 signals: taste confidence, skip rate, ROAS placeholder)
  - `POST /api/genome/folio-signal` (ingest Folio save/like/skip)
- Rollout: `POST /api/rollout/auto-playbook` returns a taste-aware IG/TikTok-first playbook object.

## Important commit references

### Folio (CORS fix)

- `folio` `main` @ `39b4cd0` — Improve CORS handling for auth callbacks.

### Slayt (selected high-impact commits)

- `a91072c` — README updated with Q2 ERRC and delivery plan.
- `37a61bc` — Taste context guardrails + schema/context/dashboard endpoints + rollout playbook API.
- `8ba93d0` — Preview selection per item + tighter hashtag prompt.
- `97ce4a6` — Strip code fences from AI caption variants in PostAIGenerator.
- `ec00d8a` — Post details: per-post state sync + persistence to backend.
- `b5aefa0` — Clean code fences in AI variants server-side + client-side.
- `c7cb1be` — Fix generation artefacts properly; multimodal caption/hashtag generation; robust JSON parsing.

## How to run (quick)

1) Folio:
```bash
cd ~/folio
rm -rf .next
PORT=3007 npm run dev
```

2) Slayt API:
```bash
cd ~/Slayt
npm run dev
```

3) Slayt client:
```bash
cd ~/Slayt/client
npm run dev -- --host --port 5173
```

## Known gaps / next steps

- “ROAS” is currently a placeholder on the 3-signal dashboard; needs real performance ingestion and attribution.
- “A/B harness” is not a full product flow yet (needs UI + storage of variants + outcome logging).
- “95% on-brand classifier” exists only as guardrail shaping and outputs; needs explicit glossary + scoring pipeline + reviewer workflow if required.
- IG/TikTok auth and cross-channel signal capture (native platform events) still needs full implementation.
- Partner “Taste API” moat: decide what should be public vs internal and add auth/rate limiting/provenance.

## Security note (do not commit secrets)

Do not paste or store API keys in chat logs. Keep secrets in `.env` files that are excluded via `.gitignore`, and rotate keys if anything sensitive was ever committed.
